<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FFL Admin</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
<header>
  <h1>FFL Admin</h1>
</header>
<main>
  <!-- Login -->
  <div class="card">
    <h2>Login</h2>
    <div class="flex">
      <input id="u" placeholder="Admin user" />
      <input id="p" type="password" placeholder="Admin password" />
      <button class="btn" id="login">Set Credentials</button>
      <span class="muted">Stored in this browser only.</span>
    </div>
  </div>

  <!-- Teams -->
  <div class="card">
    <h2>Teams</h2>
    <div class="flex">
      <input id="newTeamName" placeholder="Team name" />
      <input id="newTeamEspn" placeholder="ESPN ID (optional)" />
      <button class="btn" id="addTeamBtn">Add Team</button>
    </div>
    <table>
      <thead><tr><th>ID</th><th>Name</th><th>ESPN</th><th></th></tr></thead>
      <tbody id="teamsBody"></tbody>
    </table>
  </div>

  <!-- Schedule -->
  <div class="card">
    <h2>Schedule</h2>
    <div class="flex">
      <button class="btn" id="genBtn">Generate Double Round-Robin (18 weeks)</button>
    </div>
    <div class="flex">
      <input id="weekInput" type="number" min="0" max="17" value="0" />
      <button class="btn secondary" id="loadWeekBtn">Load Week</button>
      <button class="btn" id="saveWeekBtn">Save Week</button>
    </div>
    <table>
      <thead><tr><th>#</th><th>Team A</th><th>Team B</th></tr></thead>
      <tbody id="schedBody"></tbody>
    </table>
  </div>

  <!-- Scores -->
  <div class="card">
    <h2>Scores & Calculate</h2>
    <div class="flex">
      <input id="scoreWeek" type="number" min="0" max="17" value="0" />
      <button class="btn secondary" id="loadScoresBtn">Load Scores</button>
      <button class="btn" id="saveScoresBtn">Save Scores</button>
      <button class="btn" id="calcBtn">Calculate Awards for Week</button>
    </div>
    <table>
      <thead><tr><th>Team</th><th>Score</th></tr></thead>
      <tbody id="scoresBody"></tbody>
    </table>
    <div id="calcResult" class="muted"></div>
  </div>
</main>

<script>
// --- Helpers ---
function getAuthHeader(){
  const token = localStorage.getItem('ffl_admin_token') || '';
  return token ? { 'Authorization': 'Basic ' + token } : {};
}
document.getElementById('login').addEventListener('click', ()=>{
  const u = document.getElementById('u').value.trim();
  const p = document.getElementById('p').value;
  if(!u || !p) return alert('Enter user & password');
  localStorage.setItem('ffl_admin_token', btoa(u+':'+p));
  alert('Credentials saved in this browser.');
});

async function api(path, opts){
  const res = await fetch(path, Object.assign({ headers: Object.assign({ 'Content-Type': 'application/json' }, getAuthHeader()) }, opts));
  if(!res.ok){
    if(res.status === 401){
      alert('Unauthorized. Click "Set Credentials" with your admin user/pass.');
    } else {
      const txt = await res.text();
      alert('Error: ' + txt);
    }
    throw new Error('API error');
  }
  return res.json();
}

// --- Teams ---
async function loadTeams(){
  const rows = await api('/api/teams', { method:'GET', headers: { 'Content-Type':'application/json' } });
  const tb = document.getElementById('teamsBody'); tb.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.id}</td>
      <td><input data-id="${r.id}" data-field="name" value="${r.name}"/></td>
      <td><input data-id="${r.id}" data-field="espnId" value="${r.espnId||''}"/></td>
      <td><button class="btn secondary" data-del="${r.id}">Delete</button></td>
    `;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('input').forEach(inp=>{
    inp.addEventListener('change', async (e)=>{
      const id = e.target.getAttribute('data-id');
      const field = e.target.getAttribute('data-field');
      const payload = { id: Number(id) }; payload[field] = e.target.value;
      await api('/api/teams', { method:'PUT', body: JSON.stringify(payload) });
    });
  });
  tb.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-del');
      if(!confirm('Delete team '+id+'?')) return;
      await api('/api/teams?id='+id, { method:'DELETE' });
      await loadTeams();
    });
  });
  renderScoresEditor(rows);
}
document.getElementById('addTeamBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('newTeamName').value.trim();
  if(!name) return alert('Name required');
  const espnId = document.getElementById('newTeamEspn').value.trim();
  await api('/api/teams', { method:'POST', body: JSON.stringify({ name, espnId }) });
  document.getElementById('newTeamName').value=''; document.getElementById('newTeamEspn').value='';
  loadTeams();
});

// --- Schedule ---
async function loadWeek(){
  const week = Number(document.getElementById('weekInput').value);
  const pairs = await api('/api/schedule?week='+week, { method:'GET', headers:{ 'Content-Type':'application/json' } });
  const teams = await api('/api/teams', { method:'GET', headers:{ 'Content-Type':'application/json' } });
  const options = (val) => ['<option value="">-- pick --</option>'].concat(
    teams.map(t=>`<option value="${t.id}" ${t.id==val?'selected':''}>${t.name}</option>`)
  ).join('');
  const tb = document.getElementById('schedBody'); tb.innerHTML='';
  for(let i=0;i<5;i++){
    const p = pairs[i] || { teamA:'', teamB:'' };
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td><select id="a-${i}">${options(p.teamA)}</select></td>
      <td><select id="b-${i}">${options(p.teamB)}</select></td>
    `;
    tb.appendChild(tr);
  }
}
document.getElementById('loadWeekBtn').addEventListener('click', loadWeek);
document.getElementById('saveWeekBtn').addEventListener('click', async ()=>{
  const week = Number(document.getElementById('weekInput').value);
  const pairs = [];
  for(let i=0;i<5;i++){
    const a = Number(document.getElementById('a-'+i).value);
    const b = Number(document.getElementById('b-'+i).value);
    if(Number.isFinite(a) && Number.isFinite(b) && a && b){
      if(a===b) return alert('Pair teams must differ.');
      pairs.push({ teamA:a, teamB:b });
    }
  }
  await api('/api/schedule?week='+week, { method:'PUT', body: JSON.stringify(pairs) });
  alert('Saved schedule for week '+(week+1));
});
document.getElementById('genBtn').addEventListener('click', async ()=>{
  if(!confirm('Generate double round-robin schedule for all 18 weeks (overwrites existing)?')) return;
  await api('/api/schedule?generate=1', { method:'POST' });
  alert('Schedule generated.');
});

// --- Scores ---
function renderScoresEditor(teams){
  const tb = document.getElementById('scoresBody'); tb.innerHTML='';
  teams.forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${t.name}</td>
      <td><input type="number" step="0.01" id="score-${t.id}" /></td>
    `;
    tb.appendChild(tr);
  });
}
document.getElementById('loadScoresBtn').addEventListener('click', async ()=>{
  const week = Number(document.getElementById('scoreWeek').value);
  const rows = await api('/api/scores?week='+week, { method:'GET', headers:{ 'Content-Type':'application/json' } });
  rows.forEach(r=>{
    const inp = document.getElementById('score-'+r.teamId);
    if(inp) inp.value = r.score;
  });
});
document.getElementById('saveScoresBtn').addEventListener('click', async ()=>{
  const week = Number(document.getElementById('scoreWeek').value);
  const teams = await api('/api/teams', { method:'GET', headers:{ 'Content-Type':'application/json' } });
  const payload = {};
  teams.forEach(t=>{
    const v = document.getElementById('score-'+t.id).value;
    if(v !== '') payload[t.id] = Number(v);
  });
  await api('/api/scores?week='+week, { method:'PUT', body: JSON.stringify(payload) });
  alert('Scores saved for week '+(week+1));
});
document.getElementById('calcBtn').addEventListener('click', async ()=>{
  const week = Number(document.getElementById('scoreWeek').value);
  await api('/api/calc?week='+week, { method:'POST' });
  document.getElementById('calcResult').textContent = 'Calculated.';
  alert('Awards calculated for week '+(week+1));
});

// --- Boot ---
loadTeams();
loadWeek();
</script>
</body>
</html>

