<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FFL Admin</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
<header>
  <h1>FFL Admin</h1>
</header>
<main>
  <!-- Login -->
  <div class="card">
    <h2>Login</h2>
    <div class="flex">
      <label class="sr-only" for="u">Admin user</label>
      <input id="u" placeholder="Admin user" title="Admin user" />

      <label class="sr-only" for="p">Admin password</label>
      <input id="p" type="password" placeholder="Admin password" title="Admin password" />

      <button class="btn" id="login" type="button">Set Credentials</button>
      <span class="muted">Stored in this browser only.</span>
    </div>
  </div>

  <!-- Teams -->
  <div class="card">
    <h2>Teams</h2>
    <div class="flex">
      <label class="sr-only" for="newTeamName">Team name</label>
      <input id="newTeamName" placeholder="Team name" title="Team name" />

      <label class="sr-only" for="newTeamEspn">ESPN Team ID (0-9)</label>
      <input id="newTeamEspn" placeholder="ESPN Team ID (0-9)" title="ESPN Team ID (0-9)" />

      <button class="btn" id="addTeamBtn" type="button">Add Team</button>
    </div>
    <table>
      <thead>
        <tr>
          <th scope="col">ID</th>
          <th scope="col">Name</th>
          <th scope="col">ESPN Team ID</th>
          <th scope="col"></th>
        </tr>
      </thead>
      <tbody id="teamsBody"></tbody>
    </table>
  </div>

  <!-- Schedule -->
  <div class="card">
    <h2>Schedule</h2>
    <div class="flex">
      <button class="btn" id="genBtn" type="button">Generate Double Round-Robin (18 weeks)</button>
    </div>
    <div class="flex">
      <label class="sr-only" for="weekInput">Schedule week (0–17)</label>
      <input id="weekInput" type="number" min="0" max="17" value="0" title="Schedule week (0–17)" />
      <button class="btn secondary" id="loadWeekBtn" type="button">Load Week</button>
      <button class="btn" id="saveWeekBtn" type="button">Save Week</button>
    </div>
    <table>
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Team A</th>
          <th scope="col">Team B</th>
        </tr>
      </thead>
      <tbody id="schedBody"></tbody>
    </table>
  </div>

  <!-- Scores -->
  <div class="card">
    <h2>Scores &amp; Calculate</h2>
    <div class="flex">
      <label class="sr-only" for="scoreWeek">Scores week (0–17)</label>
      <input id="scoreWeek" type="number" min="0" max="17" value="0" title="Scores week (0–17)" />
      <button class="btn secondary" id="loadScoresBtn" type="button">Load Scores</button>
      <button class="btn" id="saveScoresBtn" type="button">Save Scores</button>
      <button class="btn" id="calcBtn" type="button">Calculate Awards for Week</button>
      <button class="btn" id="fetchEspnBtn" type="button" title="Fetch weekly totals from ESPN and fill the score inputs">Fetch from ESPN</button>
    </div>
    <table>
      <thead>
        <tr>
          <th scope="col">Team</th>
          <th scope="col">Score</th>
        </tr>
      </thead>
      <tbody id="scoresBody"></tbody>
    </table>
    <div id="calcResult" class="muted" aria-live="polite"></div>
  </div>

  <!-- ESPN Mapping -->
  <div class="card">
    <h2>ESPN Mapping</h2>
    <div class="flex" style="gap:12px">
      <label class="sr-only" for="mapLocalTeam">Local team to assign</label>
      <select id="mapLocalTeam" title="Local team to assign"></select>

      <label class="sr-only" for="espnSearch">Search ESPN teams</label>
      <input id="espnSearch" placeholder="Search ESPN teams..." title="Search ESPN teams" />

      <button class="btn" id="refreshEspn" type="button">Refresh ESPN List</button>
      <button class="btn" id="autoMapBtn" type="button" title="Try to match by name and write espn_id">Auto-map by name</button>
      <span class="muted">Tip: Select a local team, then click an ESPN team below to assign its ID.</span>
    </div>
    <table>
      <thead>
        <tr>
          <th scope="col">ESPN ID</th>
          <th scope="col">Name</th>
          <th scope="col" class="muted">Abbrev</th>
          <th scope="col"></th>
        </tr>
      </thead>
      <tbody id="espnTeamsBody"></tbody>
    </table>
    <div id="mapStatus" class="muted" aria-live="polite"></div>
  </div>
</main>

<!-- Optional: set this if your admin runs on a different host than the API -->
<script>
  // Example: window.__FFL_API_BASE__ = 'https://<your-app>.vercel.app';
  window.__FFL_API_BASE__ = window.__FFL_API_BASE__ || '';
</script>

<script>
// ----------------- Auth helpers -----------------
function getAuthHeader(){
  const token = localStorage.getItem('ffl_admin_token') || '';
  return token ? { 'Authorization': 'Basic ' + token } : {};
}
document.getElementById('login').addEventListener('click', ()=>{
  const u = document.getElementById('u').value.trim();
  const p = document.getElementById('p').value;
  if(!u || !p) return alert('Enter user & password');
  localStorage.setItem('ffl_admin_token', btoa(u+':'+p));
  alert('Credentials saved in this browser.');
});

const API_BASE = window.__FFL_API_BASE__ || '';
async function api(path, opts){
  const res = await fetch(API_BASE + path, Object.assign({
    headers: Object.assign({ 'Content-Type': 'application/json' }, getAuthHeader())
  }, opts));
  if(!res.ok){
    if(res.status === 401){
      alert('Unauthorized. Click "Set Credentials" with your admin user/pass.');
    } else {
      const txt = await res.text();
      alert('Error: ' + txt);
    }
    throw new Error('API error');
  }
  // Some endpoints may return 204/empty
  const ct = res.headers.get('content-type') || '';
  if (!ct.includes('application/json')) return {};
  return res.json();
}

// ----------------- Teams -----------------
let _teamsCache = [];
function teamLabel(t) {
  const espn = (t.espnId !== null && t.espnId !== undefined && t.espnId !== '') ? `ESPN:${t.espnId}` : 'ESPN:-';
  return `${t.name} (${espn})`;
}
function populateLocalTeamSelect(){
  const sel = document.getElementById('mapLocalTeam');
  sel.innerHTML = '<option value="">-- Select local team --</option>' + _teamsCache.map(t => `<option value="${t.id}">${teamLabel(t)}</option>`).join('');
}

async function loadTeams(){
  const rows = await api('/api/teams', { method:'GET' });
  _teamsCache = rows;

  // Teams table
  const tb = document.getElementById('teamsBody'); tb.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.id}</td>
      <td>
        <label class="sr-only" for="team-name-${r.id}">Team ${r.id} name</label>
        <input id="team-name-${r.id}" data-id="${r.id}" data-field="name" value="${r.name}" aria-label="Team ${r.id} name" title="Team ${r.id} name"/>
      </td>
      <td>
        <label class="sr-only" for="team-espn-${r.id}">Team ${r.name} ESPN ID</label>
        <input id="team-espn-${r.id}" data-id="${r.id}" data-field="espnId" value="${r.espnId||''}" placeholder="0-9" aria-label="Team ${r.name} ESPN ID" title="Team ${r.name} ESPN ID"/>
      </td>
      <td><button class="btn secondary" data-del="${r.id}" type="button">Delete</button></td>
    `;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('input').forEach(inp=>{
    inp.addEventListener('change', async (e)=>{
      const id = e.target.getAttribute('data-id');
      const field = e.target.getAttribute('data-field');
      const payload = { id: Number(id) }; payload[field] = e.target.value;
      await api('/api/teams', { method:'PUT', body: JSON.stringify(payload) });
      // update cache + dropdown labels
      const t = _teamsCache.find(x=>x.id===Number(id));
      if (t) t[field] = e.target.value;
      populateLocalTeamSelect();
    });
  });
  tb.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-del');
      if(!confirm('Delete team '+id+'?')) return;
      await api('/api/teams?id='+id, { method:'DELETE' });
      await loadTeams();
    });
  });

  renderScoresEditor(rows);
  populateLocalTeamSelect();
}

document.getElementById('addTeamBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('newTeamName').value.trim();
  if(!name) return alert('Name required');
  const espnId = document.getElementById('newTeamEspn').value.trim();
  await api('/api/teams', { method:'POST', body: JSON.stringify({ name, espnId }) });
  document.getElementById('newTeamName').value=''; document.getElementById('newTeamEspn').value='';
  loadTeams();
});

// ----------------- Schedule -----------------
async function loadWeek(){
  const week = Number(document.getElementById('weekInput').value);
  const pairs = await api('/api/schedule?week='+week, { method:'GET' });
  const teams = _teamsCache.length ? _teamsCache : await api('/api/teams', { method:'GET' });
  const options = (val) => ['<option value="">-- pick --</option>'].concat(teams.map(t=>`<option value="${t.id}" ${t.id==val?'selected':''}>${t.name}</option>`)).join('');
  const tb = document.getElementById('schedBody'); tb.innerHTML='';
  for(let i=0;i<5;i++){
    const p = pairs[i] || { teamA:'', teamB:'' };
    const pairNum = i + 1;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${pairNum}</td>
      <td>
        <label class="sr-only" for="a-${i}">Week ${week+1} pair ${pairNum} Team A</label>
        <select id="a-${i}" aria-label="Week ${week+1} pair ${pairNum} Team A" title="Week ${week+1} pair ${pairNum} Team A">${options(p.teamA)}</select>
      </td>
      <td>
        <label class="sr-only" for="b-${i}">Week ${week+1} pair ${pairNum} Team B</label>
        <select id="b-${i}" aria-label="Week ${week+1} pair ${pairNum} Team B" title="Week ${week+1} pair ${pairNum} Team B">${options(p.teamB)}</select>
      </td>
    `;
    tb.appendChild(tr);
  }
}
document.getElementById('loadWeekBtn').addEventListener('click', loadWeek);
document.getElementById('saveWeekBtn').addEventListener('click', async ()=>{
  const week = Number(document.getElementById('weekInput').value);
  const pairs = [];
  for(let i=0;i<5;i++){
    const a = Number(document.getElementById('a-'+i).value);
    const b = Number(document.getElementById('b-'+i).value);
    if(Number.isFinite(a) && Number.isFinite(b) && a && b){
      if(a===b) return alert('Pair teams must differ.');
      pairs.push({ teamA:a, teamB:b });
    }
  }
  await api('/api/schedule?week='+week, { method:'PUT', body: JSON.stringify(pairs) });
  alert('Saved schedule for week '+(week+1));
});
document.getElementById('genBtn').addEventListener('click', async ()=>{
  if(!confirm('Generate double round-robin schedule for all 18 weeks (overwrites existing)?')) return;
  await api('/api/schedule?generate=1', { method:'POST' });
  alert('Schedule generated.');
});

// ----------------- Scores -----------------
function renderScoresEditor(teams){
  const tb = document.getElementById('scoresBody'); tb.innerHTML='';
  teams.forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><label for="score-${t.id}">${t.name}</label></td>
      <td><input type="number" step="0.01" id="score-${t.id}" aria-label="Score for ${t.name}" title="Score for ${t.name}" /></td>
    `;
    tb.appendChild(tr);
  });
}
document.getElementById('loadScoresBtn').addEventListener('click', async ()=>{
  const week = Number(document.getElementById('scoreWeek').value);
  const rows = await api('/api/scores?week='+week, { method:'GET' });
  rows.forEach(r=>{
    const inp = document.getElementById('score-'+r.teamId);
    if(inp) inp.value = r.score;
  });
});
document.getElementById('saveScoresBtn').addEventListener('click', async ()=>{
  const week = Number(document.getElementById('scoreWeek').value);
  const teams = _teamsCache.length ? _teamsCache : await api('/api/teams', { method:'GET' });
  const payload = {};
  teams.forEach(t=>{
    const v = document.getElementById('score-'+t.id).value;
    if(v !== '') payload[t.id] = Number(v);
  });
  await api('/api/scores?week='+week, { method:'PUT', body: JSON.stringify(payload) });
  alert('Scores saved for week '+(week+1));
});
document.getElementById('calcBtn').addEventListener('click', async ()=>{
  const week = Number(document.getElementById('scoreWeek').value);
  await api('/api/calc?week='+week, { method:'POST' });
  document.getElementById('calcResult').textContent = 'Calculated.';
  alert('Awards calculated for week '+(week+1));
});

// ESPN weekly fetch autofill (scores)
document.getElementById('fetchEspnBtn').addEventListener('click', async ()=>{
  const zeroBasedWeek = Number(document.getElementById('scoreWeek').value); // 0..17 in our UI
  const espnWeek = zeroBasedWeek + 1; // ESPN uses 1..18
  const resp = await api('/api/espn?map=1&week='+espnWeek, { method: 'GET' });
  const teams = _teamsCache.length ? _teamsCache : await api('/api/teams', { method:'GET' });

  if (Array.isArray(resp.mapped) && resp.mapped.length) {
    resp.mapped.forEach(m => {
      const inp = document.getElementById('score-'+m.teamId);
      if (inp) inp.value = Number(m.points).toFixed(2);
    });
  } else {
    const byEspn = new Map((resp.scores||[]).map(s => [String(s.espnTeamId), Number(s.points)]));
    teams.forEach(t=>{
      const pts = byEspn.get(String(t.espnId));
      if (pts != null) {
        const inp = document.getElementById('score-'+t.id);
        if (inp) inp.value = Number(pts).toFixed(2);
      }
    });
  }
  if (Array.isArray(resp.missing) && resp.missing.length) {
    alert('Some ESPN teams did not match your Teams list (check ESPN Team IDs 0-9). Missing: ' + resp.missing.map(x=>x.espnTeamId).join(', '));
  }
  alert(`Fetched ESPN week ${espnWeek} scores. Review and press "Save Scores".`);
});

// ----------------- ESPN Mapping section -----------------
let _espnTeamsCache = [];
async function loadEspnTeams(){
  try{
    const data = await api('/api/espn-teams', { method:'GET' });
    _espnTeamsCache = data.teams || [];
    renderEspnTeams();
    document.getElementById('mapStatus').textContent = `Loaded ${_espnTeamsCache.length} ESPN teams for season ${data.season}.`;
  }catch(err){
    _espnTeamsCache = [];
    renderEspnTeams();
    document.getElementById('mapStatus').textContent = 'Failed to load ESPN teams. If league is private, set ESPN_S2 and ESPN_SWID in Vercel env and redeploy.';
  }
}
function renderEspnTeams(){
  const q = document.getElementById('espnSearch').value.toLowerCase().trim();
  const tb = document.getElementById('espnTeamsBody'); tb.innerHTML = '';
  const list = _espnTeamsCache.filter(t => {
    const hay = (t.name + ' ' + (t.abbrev || '')).toLowerCase();
    return !q || hay.includes(q);
  });
  for(const t of list){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="pill">${t.espnTeamId}</span></td>
      <td>${t.name}</td>
      <td class="muted">${t.abbrev||''}</td>
      <td><button class="btn" data-assign="${t.espnTeamId}" type="button">Assign to selected</button></td>
    `;
    tb.appendChild(tr);
  }
  tb.querySelectorAll('button[data-assign]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const espnId = btn.getAttribute('data-assign');
      const localId = Number(document.getElementById('mapLocalTeam').value);
      if(!localId) return alert('Pick a local team in the dropdown first.');
      await api('/api/teams', { method:'PUT', body: JSON.stringify({ id: localId, espnId }) });
      // update cache + UI labels
      const t = _teamsCache.find(x=>x.id===localId);
      if (t) t.espnId = espnId;
      populateLocalTeamSelect();
      // also update Teams table cell if present
      const inp = document.querySelector(`input[data-id="${localId}"][data-field="espnId"]`);
      if (inp) inp.value = espnId;
      document.getElementById('mapStatus').textContent = `Assigned ESPN ID ${espnId} to "${t?.name || localId}".`;
    });
  });
}
document.getElementById('espnSearch').addEventListener('input', renderEspnTeams);
document.getElementById('refreshEspn').addEventListener('click', loadEspnTeams);
document.getElementById('autoMapBtn').addEventListener('click', async ()=>{
  if(!confirm('Auto-map by normalized name? This will update espn_id for matching teams.')) return;
  const res = await api('/api/map-teams', { method:'POST' });
  document.getElementById('mapStatus').textContent = `Auto-map done. Updated ${res.updated||0}. ${(res.unmapped?.length||0)} still unmapped.`;
  await loadTeams();
});

// ----------------- Boot -----------------
loadTeams();
loadWeek();
loadEspnTeams();
</script>
</body>
</html>

