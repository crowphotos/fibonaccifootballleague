<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FFL Admin</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
<header>
  <h1>FFL Admin</h1>
</header>
<main>
  <!-- Login -->
  <div class="card">
    <h2>Login</h2>
    <div class="flex">
      <input id="u" placeholder="Admin user" />
      <input id="p" type="password" placeholder="Admin password" />
      <button class="btn" id="login">Set Credentials</button>
      <span class="muted">Stored in this browser only.</span>
    </div>
  </div>

  <!-- Teams -->
  <div class="card">
    <h2>Teams</h2>
    <div class="flex">
      <input id="newTeamName" placeholder="Team name" />
      <input id="newTeamEspn" placeholder="ESPN Team ID (0-9)" />
      <button class="btn" id="addTeamBtn">Add Team</button>
    </div>
    <table>
      <thead><tr><th>ID</th><th>Name</th><th>ESPN Team ID</th><th></th></tr></thead>
      <tbody id="teamsBody"></tbody>
    </table>
  </div>

  <!-- Schedule -->
  <div class="card">
    <h2>Schedule</h2>
    <div class="flex">
      <button class="btn" id="genBtn">Generate Double Round-Robin (18 weeks)</button>
    </div>
    <div class="flex">
      <input id="weekInput" type="number" min="0" max="17" value="0" />
      <button class="btn secondary" id="loadWeekBtn">Load Week</button>
      <button class="btn" id="saveWeekBtn">Save Week</button>
    </div>
    <table>
      <thead><tr><th>#</th><th>Team A</th><th>Team B</th></tr></thead>
      <tbody id="schedBody"></tbody>
    </table>
  </div>

  <!-- Scores -->
  <div class="card">
    <h2>Scores & Calculate</h2>
    <div class="flex">
      <input id="scoreWeek" type="number" min="0" max="17" value="0" />
      <button class="btn secondary" id="loadScoresBtn">Load Scores</button>
      <button class="btn" id="saveScoresBtn">Save Scores</button>
      <button class="btn" id="calcBtn">Calculate Awards for Week</button>
      <button class="btn" id="fetchEspnBtn" title="Fetch weekly totals from ESPN and fill the score inputs">Fetch from ESPN</button>
    </div>
    <table>
      <thead><tr><th>Team</th><th>Score</th></tr></thead>
      <tbody id="scoresBody"></tbody>
    </table>
    <div id="calcResult" class="muted"></div>
  </div>

  <!-- ESPN Mapping -->
  <div class="card">
    <h2>ESPN Mapping</h2>
    <div class="flex" style="gap:12px">
      <select id="mapLocalTeam"></select>
      <input id="espnSearch" placeholder="Search ESPN teams..." />
      <button class="btn" id="refreshEspn">Refresh ESPN List</button>
      <button class="btn" id="autoMapBtn" title="Try to match by name and write espn_id">Auto-map by name</button>
      <span class="muted">Tip: Select a local team, then click an ESPN team below to assign its ID.</span>
    </div>
    <table>
      <thead><tr><th>ESPN ID</th><th>Name</th><th class="muted">Abbrev</th><th></th></tr></thead>
      <tbody id="espnTeamsBody"></tbody>
    </table>
    <div id="mapStatus" class="muted"></div>
  </div>
</main>

<script>
// ----------------- Auth helpers -----------------
function getAuthHeader(){
  const token = localStorage.getItem('ffl_admin_token') || '';
  return token ? { 'Authorization': 'Basic ' + token } : {};
}
document.getElementById('login').addEventListener('click', ()=>{
  const u = document.getElementById('u').value.trim();
  const p = document.getElementById('p').value;
  if(!u || !p) return alert('Enter user & password');
  localStorage.setItem('ffl_admin_token', btoa(u+':'+p));
  alert('Credentials saved in this browser.');
});

async function api(path, opts){
  const res = await fetch(path, Object.assign({ headers: Object.assign({ 'Content-Type': 'application/json' }, getAuthHeader()) }, opts));
  if(!res.ok){
    if(res.status === 401){
      alert('Unauthorized. Click "Set Credentials" with your admin user/pass.');
    } else {
      const txt = await res.text();
      alert('Error: ' + txt);
    }
    throw new Error('API error');
  }
  return res.json();
}

// ----------------- Teams -----------------
let _teamsCache = [];
function teamLabel(t) {
  const espn = (t.espnId !== null && t.espnId !== undefined && t.espnId !== '') ? `ESPN:${t.espnId}` : 'ESPN:-';
  return `${t.name} (${espn})`;
}
function popu

